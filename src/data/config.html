<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="WTeleInfo">
        <title>Domochip WirelessTeleInfo</title>
        
        <link rel="stylesheet" href="pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
        <link rel="stylesheet" href="side-menu.css">
        <style>
            .infotip{
                background:#1Cb841;
                padding:0.3em 0.3em;
                border-radius:3px;
                color:#fff;
                font-weight:bold;
            }
            .infotipdiv{
                background:#1Cb841;
                padding:0.3em 1em;
                border-radius:3px;
                color:#fff;
                margin-bottom: 0.5em;
                display: inline-block;
            }
        </style>
    </head>
    <body>

        <div id="layout">
            <!-- Menu toggle -->
            <a href="#menu" id="menuLink" class="menu-link">
                <!-- Hamburger icon -->
                <span></span>
            </a>

            <div id="menu">
                <div class="pure-menu">
                    <div class="pure-menu-heading">Domochip</div>
                    <div class="pure-menu-heading">WTeleInfo</div>

                    <ul class="pure-menu-list">
                        <li class="pure-menu-item"><a href="./" class="pure-menu-link">Status</a></li>
                        <li class="pure-menu-item pure-menu-selected"><a href="config" class="pure-menu-link">Config</a></li>
                        <li class="pure-menu-item"><a href="fw" class="pure-menu-link">Firmware</a></li>
                    </ul>
                </div>
            </div>

            <div id="main">
                <div class="header">
                    <h1>Configuration<span id="l"><h6 style="display:inline"><b> Loading...</b></h6></span></h1>
                    <span id='i'></span><br>
                </div>

                <div class="content">
                    <h2 class="content-subhead">WiFi<span id="lw"><h6 style="display:inline"><b> Loading...</b></h6></span></h2>
                    <form class="pure-form pure-form-aligned" id='fw'>
                        <fieldset>
                            <div class="pure-control-group">
                                <label for="s">SSID</label>
                                <input type='text' id='s' name='s' maxlength='32' list="wnl">
                                <select id="wnl"><option>Searching...</option></select>
                            </div>
                            <div class="pure-control-group">
                                <label for="p">Password</label>
                                <input type='password' id='p' name='p' maxlength='64'>
                            </div>
                            <div class="pure-control-group">
                                <label for="h">Hostname</label>
                                <input type='text' id='h' name='h' maxlength='24'>
                            </div>
                            <div class="pure-control-group">
                                <label for="staticip">Static IP</label>
                                <input id='staticip' name='staticip' type="checkbox">
                            </div>
                            <div id='staticipgroup' style='display:none'>
                                <div class="pure-control-group">
                                    <label for="ip">IP</label>
                                    <input type='text' id='ip' name='ip' pattern='((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}$' required>
                                    <span class="pure-form-message-inline">*</span>
                                </div>
                                <div class="pure-control-group">
                                    <label for="gw">Gateway</label>
                                    <input type='text' id='gw' name='gw' pattern='((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}$' required>
                                    <span class="pure-form-message-inline">*</span>
                                </div>
                                <div class="pure-control-group">
                                    <label for="mask">NetMask</label>
                                    <input type='text' id='mask' name='mask' pattern='((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}$' required>
                                    <span class="pure-form-message-inline">*</span>
                                </div>
                                <div class="pure-control-group">
                                    <label for="dns1">DNS 1</label>
                                    <input type='text' id='dns1' name='dns1' pattern='((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}$'>
                                </div>
                                <div class="pure-control-group">
                                    <label for="dns2">DNS 2</label>
                                    <input type='text' id='dns2' name='dns2' pattern='((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}$'>
                                </div>
                            </div>
                            <div class="pure-controls">
                                <input type='submit' value='Save' class="pure-button pure-button-primary" disabled>
                            </div>
                        </fieldset>
                    </form>
                    <span id='rw'></span>
                            <h2 class="content-subhead">TeleInfo<span id="l1"><h6 style="display:inline"><b> Loading...</b></h6></span></h2>
        <form class="pure-form pure-form-aligned" id='f1'>
            <fieldset>

        <h3 class="content-subhead">Home Automation  <span id="hai" name="hai" class="infotip">?</span></h3>
        <div class="infotipdiv"  id="haidiv" name="haidiv" style="display:none;">
            HTTP GET request can be send to this device : <br>
            <b>http://$ip$/getAllLabel</b> : Get list of all labels (JSON List)<br>
            <b>http://$ip$/getLabel?name=$labelName$</b> : Get last value of a label, ex : PAPP (JSON)<br>
        </div>

        <div class="pure-control-group">
            <label for="haproto">Type</label>
            <select id='haproto' name='haproto'>
                <option value="0">Disabled</option>
                <option value="1">HTTP</option>
                <option value="2">MQTT</option>
            </select>
        </div>


        <div id='hae' style='display:none'>

            <div class="pure-control-group">
                <label for="hatls">SSL/TLS</label>
                <input type='checkbox' id='hatls' name='hatls'>
            </div>
            <div class="pure-control-group">
                <label for="hahost">Hostname</label>
                <input type='text' id='hahost' name='hahost' maxlength='64' pattern='[A-Za-z0-9-.]+' size='50' placeholder="IP or DNS Name">
                <span class="pure-form-message-inline">(Hostname should match with certificate name if SSL/TLS is enabled)</span>
            </div>


            <div id='hahe'>

                <div class="pure-control-group">
                    <label for="hahtype">Type</label>
                    <select id='hahtype' name='hahtype'>
                        <option value="0">Generic</option>
                        <option value="1">Jeedom TeleInfo Plugin</option>
                    </select>
                </div>

                <div id='hahtlse'>
                    <div class="pure-control-group">
                        <label for="hahfp">TLS FingerPrint</label>
                        <input type='text' id='hahfp' name='hahfp' maxlength='59' pattern='^([0-9A-Fa-f]{2}[ :-]*){19}([0-9A-Fa-f]{2})$' size='65'>
                        <span class="pure-form-message-inline">(separators are : &lt;none&gt;,&lt;space&gt;,:,-)</span>
                    </div>
                </div>

                <div id='hah0'>
                    <div class="pure-control-group">
                        <label for="hahgup">URI Pattern</label>
                        <input type='text' id='hahgup' name='hahgup' maxlength='150' size='65' placeholder="Used to generate requests URI">
                        <span id="hahgupi" name="hahgupi" class="infotip">?</span>
                    </div>

                    <div class="pure-control-group" id="hahgupidiv" name="hahgupidiv" style="display:none;">
                        <label></label>
                        <div class="infotipdiv">
                            URI Pattern placeholders : <br>
                            <b>$tls$</b> : replaced by 's' for HTTPS connection<br>
                            <b>$host$</b> : replaced by hostname<br>
                            <b>$adco$</b> : replaced the counter Serial Number<br>
                            <b>$label$</b> : replaced the current label<br>
                            <b>$val$</b> : replaced the value of the current label<br>
                            Ex : http<b>$tls$</b>://<b>$host$</b>/api/pushValue?id=<b>$label$</b>&amp;value=<b>$val$</b>
                        </div>
                    </div>
                </div>

                <div id='hah1'>
                    <div class="pure-control-group">
                        <label for="hahjak">ApiKey</label>
                        <input type='password' id='hahjak' name='hahjak' maxlength='48' pattern='[A-Za-z0-9-.]+' size=50 title='APIKey from Jeedom configuration webpage'>
                    </div>
                </div>

            </div>

            <div id='hame'>

                <div class="pure-control-group">
                    <label for="hamtype">Type</label>
                    <select id='hamtype' name='hamtype'>
                        <option value="0">Generic</option>
                    </select>
                    <span id="hamtype0i" name="hamtype0i" class="infotip">?</span>
                </div>
                <div class="pure-control-group" id="hamtype0div" name="hamtype0div" style="display:none;">
                    <label></label>
                    <div class="infotipdiv">
                        Published topics : <br>
                        <b>/$label$</b> : all labels received from the counter<br>
                    </div>
                </div>

                <div class="pure-control-group">
                    <label for="hamport">Port</label>
                    <input type='number' id='hamport' name='hamport' min='1' max='65535'>
                </div>
                <div class="pure-control-group">
                    <label for="hamu">Username</label>
                    <input type='text' id='hamu' name='hamu' maxlength='64' placeholder="optional">
                </div>
                <div class="pure-control-group">
                    <label for="hamp">Password</label>
                    <input type='password' id='hamp' name='hamp' maxlength='64' placeholder="optional">
                </div>

                <div id='hamgbte'>
                    <div class="pure-control-group">
                        <label for="hamgbt">Base Topic</label>
                        <input type='text' id='hamgbt' name='hamgbt' maxlength='64'>
                        <span id="hamgbti" name="hamgbti" class="infotip">?</span>
                    </div>

                    <div class="pure-control-group" id="hamgbtidiv" name="hamgbtidiv" style="display:none;">
                        <label></label>
                        <div class="infotipdiv">
                            Base Topic placeholders : <br>
                            <b>$adco$</b> : serial number of the counter<br>
                            <b>$sn$</b> : Serial Number of this device<br>
                            <b>$mac$</b> : WiFi MAC address of this device<br>
                            <b>$model$</b> : Model of this device<br>
                            Ex : DomoChip/<b>$adco$</b>
                        </div>
                    </div>
                </div>
            </div>
        </div>

                <div class="pure-controls">
                    <input type='submit' value='Save' class="pure-button pure-button-primary" disabled>
                </div>
            </fieldset>
        </form>
        <span id='r1'></span>
                </div>
            </div>
        </div>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
        <script>
            if (!window.jQuery){
                document.write('<script type="text/javascript" src="/jquery-3.2.1.min.js"><\/script>');
                document.getElementById('l').innerHTML=' <h4 style="display:inline"> (JQuery loaded locally)</h4>';
            }
            else $("#l").fadeOut();
        </script>
        <script>
            if (!window.jQuery) {
                document.getElementById('l').innerHTML='';
                document.getElementById('lw').innerHTML='<h6 style="display:inline;color:red;"><b> Failed</b></h6>';
                document.getElementById('i').innerHTML='<h3 style="color:red"> JQuery is required. We were not able to load it :-(</h3>';
            }
        </script>
        <script>

            function getUserIP(n){function e(e){t[e]||n(e),t[e]=!0}var a=new(window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection)({iceServers:[]}),c=function(){},t={},i=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/g;try{a.createDataChannel("")}catch(e){return void n("")}a.createOffer(function(n){n.sdp.split("\n").forEach(function(n){n.indexOf("candidate")<0||n.match(i).forEach(e)}),a.setLocalDescription(n,c,c)},c),a.onicecandidate=function(n){n&&n.candidate&&n.candidate.candidate&&n.candidate.candidate.match(i)&&n.candidate.candidate.match(i).forEach(e)}}
            function onStaticIPChange(){
                if($("#staticip").prop("checked")){
                    $("#ip").prop("required",true);
                    $("#gw").prop("required",true);
                    $("#mask").prop("required",true);
                    $("#staticipgroup").show();
                }
                else{
                    $("#ip").prop("required",false);
                    $("#gw").prop("required",false);
                    $("#mask").prop("required",false);
                    $("#staticipgroup").hide();
                }
            };
            $("#staticip").change(onStaticIPChange);

            $("#fw").submit(function(event){
                if(!$("#staticip").prop("checked")){
                    $("#ip").val('');
                    $("#gw").val('');
                    $("#mask").val('');
                    $("#dns1").val('');
                    $("#dns2").val('');
                }
                $("#rw").html("Saving Configuration...");
                $.post("/scw",$("#fw").serialize(),function(){ 
                    $("#fw").hide();
                    var reload10sec=document.createElement('script');
                    if(!$("#s").val()) reload10sec.text='var count=9;var cdi=setInterval(function(){$("#cd").text(count);if(!count){clearInterval(cdi);location.assign("http://192.168.4.1/config");}count--;},1000);';
                    else if($("#staticip").prop("checked") && $("#ip").val()!="0.0.0.0") reload10sec.text='var count=9;var cdi=setInterval(function(){$("#cd").text(count);if(!count){clearInterval(cdi);location.assign("http://' + $("#ip").val() + '/config");}count--;},1000);';
                    else reload10sec.text='var count=9;var cdi=setInterval(function(){$("#cd").text(count);if(!count){clearInterval(cdi);location.reload();}count--;},1000);';
                    $('#rw').html('<h3><b>Configuration saved <span style="color: green;">successfully</span>. System is restarting now.</b></h3>This page will be reloaded in <span id="cd">10</span>sec.').append(reload10sec);
                }).fail(function(){
                    $('#rw').html('<h3><b>Configuration <span style="color: red;">error</span>.</b></h3>');
                });
                event.preventDefault();
            });

            var getNetworkList = function (firstCall=1){

                //allow to trigger refresh of wifi networks
                if(firstCall==1) $.getJSON("/wnl", function(WNL){});

                $.getJSON("/wnl", function(WNL){
                    if(WNL.r==-2){ //if scan failed
                        $("#wnl").empty();
                        $("#wnl").append('<option>No Network Found</option>');
                    }
                    else if(WNL.r==-1){ //if scan is in progress
                        //try agin this own function without first wnl get
                        setTimeout(getNetworkList,2000,0);
                    }
                    else{ //we got result
                        $("#wnl").empty();
                        if(WNL.r==0){
                            $("#wnl").append('<option>No Network Found</option>');
                        }
                        else{
                            $("#wnl").append('<option>Choose Your Network</option>');
                            $.each(WNL.wnl,function(k,v){
                                if($("#s").val()==v) $("#wnl").append('<option value="'+v+'" selected>'+v+'</option>');
                                else $("#wnl").append('<option value="'+v+'">'+v+'</option>');
                                });
                            $("#wnl").change(function(){$("#s").val($("#wnl").val())});
                        }
                    }
                });
            }

            
        $("#hai").click(function(){$("#haidiv").slideToggle(300);});

        $("#haproto").change(function(){
            switch($("#haproto").val()){
                case "0":
                    $("#hae").hide();
                    break;
                case "1":
                    $("#hae").show();
                    $("#hahe").show();
                    $("#hame").hide();
                    break;
                case "2":
                    $("#hae").show();
                    $("#hahe").hide();
                    $("#hame").show();
                    break;
            }
        });

        $("#hahtype").change(function(){
            switch($("#hahtype").val()){
                case "0":
                    $("#hah0").show();
                    $("#hah1").hide();
                    break;
                case "1":
                    $("#hah0").hide();
                    $("#hah1").show();
                    break;
            }
        });
        $("#hahgupi").click(function(){$("#hahgupidiv").slideToggle(300);});

        $("#hamtype").change(function(){
            switch($("#hamtype").val()){
                case "0":
                    $("#hamgbte").show();
                    break;
            }
        });
        $("#hamtype0i").click(function(){$("#hamtype0div").slideToggle(300);});
        $("#hamgbti").click(function(){$("#hamgbtidiv").slideToggle(300);});

        $("#hatls").change(function(){
            if($("#hatls").prop("checked")){
                $("#hahtlse").show();
                $("#hamport").val(8883);
            }
            else{
                $("#hahtlse").hide();
                $("#hamport").val(1883);
            }
        });

        $("#f1").submit(function(event){
            $("#r1").html("Saving Configuration...");
            $.post("/sc1",$("#f1").serialize(),function(){ 
                $("#f1").hide();
                var reload5sec=document.createElement('script');
                reload5sec.text='var count=4;var cdi=setInterval(function(){$("#cd").text(count);if(!count){clearInterval(cdi);location.reload();}count--;},1000);';
                $('#r1').html('<h3><b>Configuration saved <span style="color: green;">successfully</span>. System is restarting now.</b></h3>This page will be reloaded in <span id="cd">5</span>sec.').append(reload5sec);
            }).fail(function(){
                $('#r1').html('<h3><b>Configuration <span style="color: red;">error</span>.</b></h3>');
            });
            event.preventDefault();
        });

            $(document).ready(function(){
                $.getJSON("/gcw", function(GCW){

                    $.each(GCW,function(k,v){

                        if($('#'+k).prop('type')!='checkbox') $('#'+k).val(v);
                        else $('#'+k).prop("checked",v);

                        $('#'+k).trigger("change");
                    })

                    $("input[type=submit]",$("#fw")).prop("disabled",false);
                    $("#lw").fadeOut();

                    getNetworkList();
                })
                .fail(function(){
                    $("#lw").html('<h6 style="display:inline;color:red;"><b> Failed</b></h6>');
                });

                        $.getJSON("/gc1", function(GC1){

            $.each(GC1,function(k,v){

                if($('#'+k).prop('type')!='checkbox') $('#'+k).val(v);
                else $('#'+k).prop("checked",v);

                $('#'+k).trigger("change");
            })

            $("input[type=submit]",$("#f1")).prop("disabled",false);
            $("#l1").fadeOut();
        })
        .fail(function(){
            $("#l1").html('<h6 style="display:inline;color:red;"><b> Failed</b></h6>');
        });
            });
        </script>
        <script src="side-menu.js"></script>
    </body>
</html>
